<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="../../CSS/Admin-Css/products-admin.css">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ù…ØªØ¬Ø±</title>
 
</head>
<body>
<h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h1>

<div class="nav">
  <button data-tab="products" class="active">ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
  <button data-tab="categories">ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</button>
</div>

<div id="message" class="msg"></div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
<section id="products" class="active">
  <div class="top" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
    <input id="search" type="search" placeholder="Ø§Ø¨Ø­Ø«...">
    <select id="filterCategory"><option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option></select>
    <button id="openAdd" class="primary">+ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
  </div>
  <div id="productsGrid" class="grid"></div>
</section>

<!-- Ù‚Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
<section id="categories">
  <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h2>
  <form id="catForm" style="margin-bottom:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <input id="catName" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ">
    <button class="primary">Ø¥Ø¶Ø§ÙØ©</button>
  </form>
  <div id="categoriesList" class="cat-list"></div>
</section>

<!-- ================= Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ ================= -->
<div id="addModal" class="modal">
  <div class="box">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3>
    <form id="addForm">
      <div class="file-input-wrapper">
        <label>ØµÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ± Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ù‡Ø§ Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©):</label>
        <input id="addImagesInput" type="file" multiple accept="image/*">
      </div>
      <!-- Ø­Ø§ÙˆÙŠØ© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± -->
      <div id="addPreviewContainer" class="upload-preview-container">
        <span style="font-size:12px; color:#888; width:100%; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø®ØªØ§Ø±Ø©</span>
      </div>

      <input name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *" required>
      <textarea name="description" rows="3" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
      
      <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
      <label style="font-size:13px; font-weight:bold;">Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…ØªØ§Ø­Ø© <span class="optional-txt">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>:</label>
      <div class="color-picker-container">
        <input type="color" id="addColorPicker" value="#ff0000" style="width:50px; height:35px; cursor:pointer;">
        <button type="button" id="btnAddColor" style="padding: 5px 10px; font-size:12px;">+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ†</button>
      </div>
      <div id="addColorsContainer" class="selected-colors-box"></div>
      <input type="hidden" name="colors" id="addColorsInput">
      
      <!-- Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª -->
      <label style="font-size:13px; font-weight:bold;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª <span class="optional-txt">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>:</label>
      <input name="sizes" type="text" placeholder="Ù…Ø«Ø§Ù„: S, M, L">

      <input name="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± *" required>
      <select name="category_id" id="addCategory"><option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option></select>
      <div style="text-align:end;">
        <button type="button" data-close>Ø¥Ù„ØºØ§Ø¡</button>
        <button class="primary" type="submit">Ø­ÙØ¸</button>
      </div>
    </form>
  </div>
</div>

<!-- ================= Ù…ÙˆØ¯Ø§Ù„ ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ ================= -->
<div id="editModal" class="modal">
  <div class="box">
    <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h3>
    <div class="small" id="editIdLabel"></div>
    
    <!-- Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© -->
    <div style="font-size:12px; margin-bottom:5px;">Ø§Ù„ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</div>
    <div id="currentImages" class="preview-images" style="margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;"></div>

    <form id="editForm">
      <div class="file-input-wrapper">
        <label>ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ± (Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„):</label>
        <input id="editImagesInput" type="file" multiple accept="image/*">
      </div>
       <!-- Ø­Ø§ÙˆÙŠØ© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
      <div id="editPreviewContainer" class="upload-preview-container">
        <span style="font-size:12px; color:#888; width:100%; text-align:center;">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©</span>
      </div>
      
      <input name="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *" required>
      <textarea name="description" rows="3" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
      
      <label style="font-size:13px; font-weight:bold;">Ø§Ù„Ø£Ù„ÙˆØ§Ù† <span class="optional-txt">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>:</label>
      <div class="color-picker-container">
        <input type="color" id="editColorPicker" value="#000000" style="width:50px; height:35px; cursor:pointer;">
        <button type="button" id="btnEditColor" style="padding: 5px 10px; font-size:12px;">+ Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ†</button>
      </div>
      <div id="editColorsContainer" class="selected-colors-box"></div>
      <input type="hidden" name="colors" id="editColorsInput">
      
      <label style="font-size:13px; font-weight:bold;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª <span class="optional-txt">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>:</label>
      <input name="sizes" type="text" placeholder="Ø­Ø±Ø± Ù†Øµ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª">

      <input name="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± *" required>
      <select name="category_id" id="editCategory"><option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option></select>
      <div style="text-align:end;">
        <button type="button" data-close>Ø¥Ù„ØºØ§Ø¡</button>
        <button class="primary" type="submit">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </form>
  </div>
</div>

<script>
const $=s=>document.querySelector(s);
let PRODUCTS=[],FILTERED=[],editingId=null;
const msgBox=$('#message');

// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± Ù…Ø±ØªØ¨Ø©
let addFilesBuffer = [];
let editFilesBuffer = [];

function showMsg(txt,ok=true,time=2500){
  msgBox.textContent=txt;
  msgBox.className='msg '+(ok?'ok':'err');
  msgBox.style.display='block';
  if(time)setTimeout(()=>msgBox.style.display='none',time);
}

// ------------------- Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙˆØ± -------------------

// Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙØ±
function handleFileSelect(event, bufferRef, containerId) {
  const files = Array.from(event.target.files);
  // Ù†Ø¶ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
  files.forEach(f => bufferRef.push(f));
  renderPreviews(bufferRef, containerId);
  // ØªØµÙÙŠØ± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù†ÙØ³ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ø°Ø§ Ù„Ø²Ù…
  event.target.value = '';
}

// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
function renderPreviews(buffer, containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  if (buffer.length === 0) {
    container.innerHTML = '<span style="font-size:12px; color:#888; width:100%; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø®ØªØ§Ø±Ø©</span>';
    return;
  }

  buffer.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const div = document.createElement('div');
      div.className = 'img-preview-box';
      if (index === 0) div.classList.add('is-main'); // Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù‡ÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      div.title = "Ø§Ø¶ØºØ· Ù„ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒØµÙˆØ±Ø© Ø±Ø¦ÙŠØ³ÙŠØ©";

      // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±: Ø¬Ø¹Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ù‡ÙŠ Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)
      div.onclick = (evt) => {
        if(evt.target.classList.contains('remove-img-btn')) return; // ØªØ¬Ø§Ù‡Ù„ Ø²Ø± Ø§Ù„Ø­Ø°Ù
        // Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ØµÙÙˆÙØ©
        const selectedFile = buffer.splice(index, 1)[0];
        buffer.unshift(selectedFile);
        renderPreviews(buffer, containerId);
      };

      const img = document.createElement('img');
      img.src = e.target.result;
      
      const delBtn = document.createElement('span');
      delBtn.className = 'remove-img-btn';
      delBtn.innerText = 'Ã—';
      delBtn.onclick = (evt) => {
        evt.stopPropagation(); // Ù…Ù†Ø¹ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ onclick Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚
        buffer.splice(index, 1);
        renderPreviews(buffer, containerId);
      };

      div.appendChild(img);
      div.appendChild(delBtn);
      container.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
}

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„ØµÙˆØ±
$('#addImagesInput').addEventListener('change', (e) => handleFileSelect(e, addFilesBuffer, 'addPreviewContainer'));
$('#editImagesInput').addEventListener('change', (e) => handleFileSelect(e, editFilesBuffer, 'editPreviewContainer'));


// ------------------- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù„ÙˆØ§Ù† -------------------
function createColorChip(colorCode, containerId, hiddenInputId) {
  const container = document.getElementById(containerId);
  const hiddenInput = document.getElementById(hiddenInputId);
  
  const currentColors = hiddenInput.value ? hiddenInput.value.split(',') : [];
  if(currentColors.includes(colorCode)) return; 

  const chip = document.createElement('div');
  chip.className = 'color-chip';
  chip.style.backgroundColor = colorCode;
  
  chip.onclick = function() {
    container.removeChild(chip);
    updateHiddenInput(containerId, hiddenInputId);
  };
  
  container.appendChild(chip);
  updateHiddenInput(containerId, hiddenInputId);
}

function updateHiddenInput(containerId, hiddenInputId) {
  const container = document.getElementById(containerId);
  const chips = container.querySelectorAll('.color-chip');
  const colors = [];
  chips.forEach(chip => {
    colors.push(rgbToHex(chip.style.backgroundColor) || chip.style.backgroundColor); 
  });
  document.getElementById(hiddenInputId).value = colors.join(',');
}

function rgbToHex(rgb) {
  if(!rgb || rgb.startsWith('#')) return rgb;
  const sep = rgb.indexOf(",") > -1 ? "," : " ";
  const rgbArr = rgb.substr(4).split(")")[0].split(sep);
  let r = (+rgbArr[0]).toString(16),
      g = (+rgbArr[1]).toString(16),
      b = (+rgbArr[2]).toString(16);
  if (r.length == 1) r = "0" + r;
  if (g.length == 1) g = "0" + g;
  if (b.length == 1) b = "0" + b;
  return "#" + r + g + b;
}

$('#btnAddColor').onclick = () => { createColorChip($('#addColorPicker').value, 'addColorsContainer', 'addColorsInput'); };
$('#btnEditColor').onclick = () => { createColorChip($('#editColorPicker').value, 'editColorsContainer', 'editColorsInput'); };

function clearColors(containerId, hiddenInputId) {
  document.getElementById(containerId).innerHTML = '';
  document.getElementById(hiddenInputId).value = '';
}

// ------------------- Ø¯ÙˆØ§Ù„ API -------------------
async function apiFetchProducts(){ const res=await fetch('/products'); if(!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª'); return res.json(); }
async function apiDeleteProduct(id){ return fetch(`/products/${id}`,{method:'DELETE'}); }
async function apiUpdateProduct(id,fd){ return fetch(`/products/${id}`,{method:'PUT',body:fd}); }
async function apiCreateProduct(fd){ return fetch('/products',{method:'POST',body:fd}); }
async function apiFetchCategories(){ const res=await fetch('/categories'); if(!res.ok) throw new Error('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª'); return res.json(); }
async function apiCreateCategory(name){ const res=await fetch('/categories',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})}); if(!res.ok) throw new Error('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ'); return res.json(); }
async function apiUpdateCategory(id,name){ const res=await fetch(`/categories/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})}); if(!res.ok) throw new Error('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµÙ†ÙŠÙ'); return res.json(); }
async function apiDeleteCategory(id){ const res=await fetch(`/categories/${id}`,{method:'DELETE'}); if(!res.ok) throw new Error('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙ'); return res; }

function getMainImage(p) {
  if (p.images && Array.isArray(p.images) && p.images.length > 0) return p.images[0];
  return p.image || 'https://via.placeholder.com/90?text=No+Image';
}

function renderProducts(){
  const c=$('#productsGrid');c.innerHTML='';
  if(!FILTERED.length){c.innerHTML='<div style="grid-column:1/-1;color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>';return;}
  for(const p of FILTERED){
    const imgSrc = getMainImage(p);
    let sizesHtml = '';
    if(p.sizes && p.sizes.trim().length > 0) sizesHtml = `<div class="tags-info"><span class="label">ğŸ“ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:</span> ${escapeHtml(p.sizes)}</div>`;
    
    let colorsHtml = '';
    if(p.colors) {
        let cArr = Array.isArray(p.colors) ? p.colors : p.colors.split(',');
        cArr = cArr.filter(x => x && x.trim() !== '');
        if(cArr.length > 0) {
            let dots = '';
            cArr.forEach(col => { dots += `<span class="color-dot" style="background-color:${col.trim()}" title="${col}"></span>`; });
            colorsHtml = `<div class="tags-info"><span class="label">ğŸ¨ Ø§Ù„Ø£Ù„ÙˆØ§Ù†:</span> ${dots}</div>`;
        }
    }

    c.insertAdjacentHTML('beforeend',`<div class="card">
      <img class="thumb" src="${imgSrc}">
      <div class="meta">
        <h3>${escapeHtml(p.name)}</h3>
        <p>${escapeHtml(p.description||'')}</p>
        ${colorsHtml}
        ${sizesHtml}
        <div class="price">${Number(p.price).toLocaleString()} Ø¯Ø¬</div>
        <div class="small">${escapeHtml(p.category_name||'')}</div>
        <div class="actions">
          <button class="edit" data-id="${p.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="danger delete" data-id="${p.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
    </div>`);
  }
}

function renderCategories(cats){
  const box=$('#categoriesList'); box.innerHTML='';
  if(!cats.length){box.innerHTML='<div style="color:#666;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµÙ†ÙŠÙØ§Øª</div>';return;}
  for(const c of cats){
    box.insertAdjacentHTML('beforeend',`
      <div class="cat-item">
        <span>${escapeHtml(c.name)}</span>
        <div class="cat-actions">
          <button class="edit" data-id="${c.id}" data-name="${c.name}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="danger delete" data-id="${c.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
    `);
  }
  box.querySelectorAll('.delete').forEach(b=>b.onclick=async()=>{
    if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
    try{await apiDeleteCategory(b.dataset.id);showMsg('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙ'); loadCategories();}
    catch(e){showMsg('âŒ '+e.message,false);}
  });
  box.querySelectorAll('.edit').forEach(b=>b.onclick=async()=>{
    const newName=prompt('Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªØµÙ†ÙŠÙ:',b.dataset.name);
    if(!newName) return;
    try{await apiUpdateCategory(b.dataset.id,newName);showMsg('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«'); loadCategories();}
    catch(e){showMsg('âŒ '+e.message,false);}
  });
}

// ------------------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ (Forms) ÙˆØªØ¹Ø¯ÙŠÙ„ FormData -------------------

// Ø§Ù„Ø¥Ø¶Ø§ÙØ©
$('#addForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const fd = new FormData(e.target);
  
  // Ù†Ù‚ÙˆÙ… Ø¨Ø­Ø°Ù Ø­Ù‚Ù„ Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ø£Ù†Ù‡ Ù‚Ø¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
  fd.delete('images');
  
  // Ù†Ø¶ÙŠÙ Ø§Ù„ØµÙˆØ± Ù…Ù† Ø§Ù„Ø¨ÙØ± Ø§Ù„Ù…Ø±ØªØ¨
  addFilesBuffer.forEach(file => {
    fd.append('images', file);
  });

  try{
    await apiCreateProduct(fd);
    showMsg('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');
    $('#addModal').style.display='none';
    e.target.reset();
    clearColors('addColorsContainer', 'addColorsInput');
    addFilesBuffer = []; // ØªØµÙÙŠØ± Ø§Ù„ØµÙˆØ±
    renderPreviews([], 'addPreviewContainer');
    init();
  }
  catch(err){showMsg('âŒ '+err.message,false);}
});

// Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
$('#editForm').addEventListener('submit',async e=>{
  e.preventDefault();
  if(!editingId) return;
  const fd = new FormData(e.target);
  
  // Ø¥Ø°Ø§ Ù‚Ø§Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù†Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„Ø¨ÙØ± Ø§Ù„Ù…Ø±ØªØ¨
  if(editFilesBuffer.length > 0) {
      fd.delete('images');
      editFilesBuffer.forEach(file => {
          fd.append('images', file);
      });
  }

  try{await apiUpdateProduct(editingId,fd);showMsg('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«');$('#editModal').style.display='none';init();}
  catch(err){showMsg('âŒ '+err.message,false);}
});


// ------------------- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« -------------------
$('#productsGrid').addEventListener('click',async e=>{
  const id=e.target.dataset.id;
  if(e.target.classList.contains('delete')){
    if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
    try{await apiDeleteProduct(id);showMsg('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù'); init();}
    catch(err){showMsg('âŒ '+err.message,false);}
  }
  if(e.target.classList.contains('edit')){
    const p=PRODUCTS.find(x=>x.id==id);
    if(!p)return;
    editingId=id;
    $('#editIdLabel').textContent='ID: '+id;
    
    // Ø¥ÙØ±Ø§Øº Ø¨ÙØ± Ø§Ù„ØµÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
    editFilesBuffer = [];
    renderPreviews([], 'editPreviewContainer');
    $('#editImagesInput').value = '';

    const imgBox = $('#currentImages');
    imgBox.innerHTML = '';
    let imagesArr = (p.images && Array.isArray(p.images)) ? p.images : (p.image ? [p.image] : []);
    if(imagesArr.length){
        imagesArr.forEach(url => {
          // Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø· Ù„Ù„Ø¹Ø±Ø¶
          const img = document.createElement('img');
          img.src = url; img.style.width='60px'; img.style.height='60px'; img.style.marginRight='5px';
          imgBox.appendChild(img);
        });
    } else {
        imgBox.innerHTML = '<span style="font-size:12px;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</span>';
    }

    const f=$('#editForm');
    f.name.value=p.name; 
    f.description.value=p.description||''; 
    f.price.value=p.price||0; 
    f.category_id.value=p.category_id||'';
    f.sizes.value = p.sizes || ''; 
    
    clearColors('editColorsContainer', 'editColorsInput');
    let dbColors = [];
    if(p.colors) dbColors = Array.isArray(p.colors) ? p.colors : p.colors.split(',');
    dbColors.forEach(c => {
        if(c && c.trim()) createColorChip(c.trim(), 'editColorsContainer', 'editColorsInput');
    });

    $('#editModal').style.display='grid';
  }
});

$('#catForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const name=$('#catName').value.trim();
  if(!name) return;
  try{await apiCreateCategory(name);showMsg('âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©');$('#catName').value='';loadCategories();}
  catch(err){showMsg('âŒ '+err.message,false);}
});

$('#search').addEventListener('input',()=>filterRender());
$('#filterCategory').addEventListener('change',()=>filterRender());

function filterRender(){
  const q=$('#search').value.trim().toLowerCase();
  const catId=$('#filterCategory').value;
  FILTERED=PRODUCTS.filter(p=>{
    const matchText=(p.name||'').toLowerCase().includes(q)||(p.description||'').toLowerCase().includes(q);
    const matchCat=!catId||p.category_id==catId;
    return matchText&&matchCat;
  });
  renderProducts();
}
function escapeHtml(str){return (str||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}

async function init(){
  try{
    PRODUCTS=await apiFetchProducts();
    FILTERED=[...PRODUCTS];
    renderProducts();
    loadCategories();
  }catch(e){showMsg('âŒ '+e.message,false);}
}
async function loadCategories(){
  try{
    const cats=await apiFetchCategories();
    renderCategories(cats);
    const add=$('#addCategory'),edit=$('#editCategory'),filter=$('#filterCategory');
    const defaultOpt = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>';
    add.innerHTML=defaultOpt; edit.innerHTML=defaultOpt; filter.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>';
    for(const c of cats){
      const opt=`<option value="${c.id}">${escapeHtml(c.name)}</option>`;
      add.insertAdjacentHTML('beforeend',opt);
      edit.insertAdjacentHTML('beforeend',opt);
      filter.insertAdjacentHTML('beforeend',opt);
    }
  }catch(e){showMsg('âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª',false);}
}

document.querySelectorAll('[data-close]').forEach(b=>b.onclick=()=>b.closest('.modal').style.display='none');

$('#openAdd').onclick=()=>{
  $('#addForm').reset();
  clearColors('addColorsContainer', 'addColorsInput');
  addFilesBuffer = [];
  renderPreviews([], 'addPreviewContainer');
  $('#addModal').style.display='grid';
};

document.querySelectorAll('.nav button').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
    document.getElementById(btn.dataset.tab).classList.add('active');
  };
});

init();
</script>
</body>
</html>