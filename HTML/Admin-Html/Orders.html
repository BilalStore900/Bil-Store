<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="../../../../CSS/Admin-Css/Orders.css">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
 
</head>
<body>

  <h1>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>

  <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">

  <table>
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†</th>
        <th>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø§Ù„Ù…Ù†ØªØ¬</th> 
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="ordersTable">
      <tr><td colspan="4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</td></tr>
    </tbody>
  </table>

  <div id="orderModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

  <script>
    const ordersTable = document.getElementById("ordersTable");
    const searchInput = document.getElementById("searchInput");
    const modal = document.getElementById("orderModal");
    const modalBody = document.getElementById("modalBody");
    const closeModal = document.getElementById("closeModal");

    let allOrders = [];

    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function loadOrders() {
      try {
        const res = await fetch("/orders"); 
        if (!res.ok) throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª");
        allOrders = await res.json();
        displayOrders(allOrders);
      } catch (err) {
        console.error(err);
        ordersTable.innerHTML = "<tr><td colspan='4'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ù€ API.</td></tr>";
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function displayOrders(orders) {
      if (!orders.length) {
        ordersTable.innerHTML = "<tr><td colspan='4'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>";
        return;
      }

      ordersTable.innerHTML = "";
      orders.forEach(order => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        const hasNotes = order.customer_notes && order.customer_notes.trim() !== "";
        const noteIcon = hasNotes ? '<span title="ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø©" style="cursor:help;"></span>' : '';

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø®ÙŠØ§Ø±Ø§Øª (Ù„ÙˆÙ† Ø£Ùˆ Ù…Ù‚Ø§Ø³) Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø§Ø®ØªØµØ§Ø± ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let specsInfo = '';
        if(order.customer_color) specsInfo += '<span class="specs-badge" title="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ†"></span>';
        if(order.customer_size) specsInfo += '<span class="specs-badge" title="ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù‚Ø§Ø³"></span>';

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="clickable">
            ${order.customer_name} ${noteIcon} 
          </td>
          <td class="clickable">${order.customer_phone || '-'}</td>
          <td class="clickable">
            ${order.product_name}
            ${specsInfo} <!-- Ø¹Ø±Ø¶ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ù‡Ù†Ø§ -->
          </td>
          <td>
            ${order.status !== 'confirmed' ? `<button class="confirm" onclick="confirmOrder(${order.id})">ØªØ£ÙƒÙŠØ¯</button>` : '<span style="color:var(--color-confirm); font-weight:bold; margin-left:10px;">ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯</span>'}
            <button class="delete" onclick="deleteOrder(${order.id})">Ø­Ø°Ù</button>
          </td>
        `;

        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø®Ù„Ø§ÙŠØ§
        tr.querySelectorAll('.clickable').forEach(cell => {
          cell.addEventListener("click", () => showOrderDetails(order));
        });

        ordersTable.appendChild(tr);
      });
    }

    // --- Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª) ---
    function showOrderDetails(order) {
      const date = new Date(order.created_at || Date.now()).toLocaleString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: false
      });
      
      const formatNumber = (num) => {
        if (!num) return '0 DA';
        return parseFloat(num).toLocaleString('en-US', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        }) + ' DA';
      }
      
      const unitPrice = formatNumber(order.product_price);
      const totalPrice = formatNumber(order.total_price);
      const notesContent = order.customer_notes ? order.customer_notes : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©';
      const notesColor = order.customer_notes ? '#d9534f' : '#888';

      // --- ØªØ¬Ù‡ÙŠØ² HTML Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³ ---
      
      // 1. Ø§Ù„Ù„ÙˆÙ†
      let colorRow = '';
      if (order.customer_color) {
        colorRow = `
          <div class="info-row">
            <div class="label">  Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø®ØªØ§Ø±:</div>
            <div class="value" style="display:flex; align-items:center; gap:8px;">
               <span class="color-preview" style="background-color: ${order.customer_color};"></span>
               <!-- Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ ÙƒÙˆØ¯ Ø§Ù„Ù„ÙˆÙ† ÙƒÙ†Øµ Ø£ÙŠØ¶Ø§Ù‹ -->
               <span style="font-size:0.9em; color:#666;">${order.customer_color}</span>
            </div>
          </div>
        `;
      } else {
        colorRow = `<div class="info-row"><div class="label">  Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…Ø®ØªØ§Ø±:</div><div class="value" style="color:#999;">-</div></div>`;
      }

      // 2. Ø§Ù„Ù…Ù‚Ø§Ø³
      let sizeRow = '';
      if (order.customer_size) {
        sizeRow = `
          <div class="info-row">
            <div class="label">  Ø§Ù„Ù…Ù‚Ø§Ø³:</div>
            <div class="value" style="font-weight:bold;">${order.customer_size}</div>
          </div>
        `;
      } else {
        sizeRow = `<div class="info-row"><div class="label">  Ø§Ù„Ù…Ù‚Ø§Ø³:</div><div class="value" style="color:#999;">-</div></div>`;
      }

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
      modalBody.innerHTML = `
        <div class="paper-header">
            <h2>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
            <small>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: INV-${order.id}</small>
        </div>

        <div class="info-grid">
            <div class="info-row"><div class="label">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:</div><div class="value">${order.customer_name}</div></div>
            <div class="info-row"><div class="label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</div><div class="value">${order.customer_phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div></div>
            <div class="info-row"><div class="label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</div><div class="value">${order.customer_address || 'Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±'}</div></div>
            
            <div class="info-row" style="background-color: #f9f9f9; padding: 5px; border-radius: 4px;">
                <div class="label">  Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø²Ø¨ÙˆÙ†:</div>
                <div class="value" style="white-space: pre-wrap; color: ${notesColor}; font-weight: bold;">${notesContent}</div>
            </div>

            <div class="info-row"><div class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨:</div><div class="value">${date}</div></div>
            
            <div class="info-row" style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;"></div>
            
            <div class="info-row"><div class="label">Ø§Ù„Ù…Ù†ØªØ¬:</div><div class="value"><strong>${order.product_name}</strong></div></div>
            
            <!-- ğŸ‘‡ Ø¥Ø¶Ø§ÙØ© ØµÙÙˆÙ Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³ Ù‡Ù†Ø§ ğŸ‘‡ -->
            ${colorRow}
            ${sizeRow}
            <!-- ğŸ‘† -------------------------- ğŸ‘† -->

            <div class="info-row"><div class="label">Ø§Ù„ÙƒÙ…ÙŠØ©:</div><div class="value">${order.quantity || 1}</div></div>
            <div class="info-row"><div class="label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©:</div><div class="value">${unitPrice}</div></div>
            <div class="info-row"><div class="label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</div><div class="value" style="font-size:1.2em; color:var(--color-dark-blue);">${totalPrice}</div></div>
            <div class="info-row"><div class="label">Ø§Ù„Ø­Ø§Ù„Ø©:</div><div class="value">${order.status === 'confirmed' ? 'Ù…Ø¤ÙƒØ¯' : 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹'}</div></div>
        </div>

        <div class="modal-footer">
            <p>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ„Ù…: ...........................</p>
            <p style="margin-top:10px;">Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§Ù…Ù„ÙƒÙ… Ù…Ø¹Ù†Ø§.</p>
        </div>
      `;
      modal.style.display = "block";
    }

    closeModal.onclick = () => { modal.style.display = "none"; }
    window.onclick = e => { if (e.target === modal) modal.style.display = "none"; }

    async function confirmOrder(orderId) {
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ£ÙƒÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
      try {
        const res = await fetch(`/orders/${orderId}/confirm`, { method: "PUT", headers: { "Content-Type": "application/json" } });
        if (!res.ok) throw new Error("ÙØ´Ù„");
        await loadOrders(); 
      } catch (err) {
        console.error(err);
        alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ£ÙƒÙŠØ¯");
      }
    }

    async function deleteOrder(orderId) {
      if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
      try {
        const res = await fetch(`/orders/${orderId}`, { method: "DELETE" });
        if (!res.ok) throw new Error("ÙØ´Ù„");
        
        const rows = Array.from(ordersTable.rows);
        const rowIndex = rows.findIndex(r => r.innerText.includes(`#${orderId}`));
   
        loadOrders(); 
      } catch (err) {
        console.error(err);
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨");
      }
    }

    searchInput.addEventListener("input", () => {
      const query = searchInput.value.toLowerCase();
      const filtered = allOrders.filter(order =>
        order.customer_name.toLowerCase().includes(query) ||
        (order.customer_phone && order.customer_phone.includes(query))
      );
      displayOrders(filtered);
    });

    loadOrders();
  </script>
</body>
</html>