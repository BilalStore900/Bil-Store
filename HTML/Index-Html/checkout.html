<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</title>
  <link rel="stylesheet" href="../../CSS/checkout.css">
  
  <style>
    /* ğŸ¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„ÙˆÙ†ÙŠØ© */
    :root {
      --true-black: #000000;
      --dark-grey: #1c1c1c;
      --neon-blue: #00f2ff;
      --neon-glow: 0 0 10px rgba(0, 242, 255, 0.7);
    }

    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª --- */
    .options-container {
      margin-bottom: 15px;
    }
    
    .color-wrapper {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 5px;
    }

    .color-option {
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #000000;
      transition: all 0.2s ease;
      box-shadow: 0 2px 5px rgb(0, 0, 0);
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    /* Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† */
    .color-option.selected {
      border: 3px solid var(--neon-blue);
      box-shadow: 0 0 8px var(--neon-blue);
      transform: scale(1.15);
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª */
.size-select {
  width: 100%;
  padding: 10px;
  border: 1px solid #ffffff;
  border-radius: 5px;
  margin-top: 5px;
  font-size: 16px;
  /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù‡Ù†Ø§: */
  background: #2b2b2b;  
  color: #ffffff; 
   }   

    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (Ù…ÙˆØ¯ Ù†ÙŠÙˆÙ†) --- */
    .success-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      background-color: var(--true-black);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      animation: fadeIn 0.8s ease-in-out;
    }

    .success-card {
      text-align: center;
      padding: 40px;
      max-width: 90%;
      width: 400px;
      background: var(--dark-grey);
      border: 1px solid #333;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0, 242, 255, 0.1);
    }

    /* SVG Animation */
    .checkmark-svg {
      width: 80px;
      height: 80px;
      display: block;
      margin: 0 auto 20px auto;
      stroke-width: 2.5;
      stroke: var(--neon-blue);
      stroke-miterlimit: 10;
      filter: drop-shadow(0 0 5px var(--neon-blue));
      animation: scale .3s ease-in-out .9s both;
    }
    .checkmark-circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 2;
      stroke: var(--neon-blue);
      fill: none;
      animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .checkmark-check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .success-title { color: var(--neon-blue); font-size: 26px; margin-bottom: 10px; font-weight: bold; text-shadow: var(--neon-glow); }
    .success-text { font-size: 16px; color: #e0e0e0; margin-bottom: 30px; line-height: 1.6; }

    .home-btn {
      display: inline-block;
      background-color: transparent;
      color: var(--neon-blue);
      padding: 12px 30px;
      text-decoration: none;
      border: 2px solid var(--neon-blue);
      border-radius: 50px;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 0 5px rgba(0, 242, 255, 0.2);
    }
    .home-btn:hover {
      background-color: var(--neon-blue);
      color: var(--true-black);
      box-shadow: 0 0 20px rgba(0, 242, 255, 0.6);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  
  <h1 id="pageTitle">Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡</h1>

  <div id="productInfo">
    <p>â³ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬...</p>
  </div>

  <form id="orderForm">
    
    <!-- Ù‚Ø³Ù… Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ø£Ù„ÙˆØ§Ù† ÙˆÙ…Ù‚Ø§Ø³Ø§Øª) -->
    <fieldset id="productOptionsSet" style="display:none;">
      <legend>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</legend>
      
      <!-- Ø§Ù„Ø£Ù„ÙˆØ§Ù† -->
      <div id="colorsSection" class="options-container" style="display:none;">
        <label style="font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù„ÙˆÙ†:</label>
        <div id="colorsContainer" class="color-wrapper"></div>
        <input type="hidden" name="color" id="selectedColorInput">
        <p id="colorError" style="color:red; font-size:12px; display:none;">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù„ÙˆÙ†</p>
      </div>

      <!-- Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª -->
      <div id="sizesSection" class="options-container" style="display:none;">
        <label style="font-weight:bold;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³:</label>
        <div id="sizesContainer"></div> <!-- Ø³ÙŠØªÙ… Ø­Ù‚Ù† Select Ø£Ùˆ Input Ù‡Ù†Ø§ -->
      </div>
    </fieldset>

    <fieldset>
      <legend>Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</legend>
      <label>Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„:</label>
      <input type="text" name="customer_name" required placeholder="Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨">

      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
      <input type="tel" name="customer_phone" required placeholder="0XXXXXXXXX">

      <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† :</label>
      <textarea name="customer_address" rows="2" required placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨"></textarea>

      <label style="margin-top: 10px; display:block;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
      <textarea name="customer_notes" rows="2" placeholder=" ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ùƒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§ "></textarea>
    </fieldset>

    <fieldset>
      <legend>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</legend>
      <label>Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
      <input type="number" id="quantity" name="quantity" min="1" value="1" required>
    </fieldset>

    <p id="totalPrice" style="font-weight:bold; font-size:1.2em; margin:15px 0;">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¯Ø¬</p>

    <button type="submit" style="width:100%; padding:12px; font-weight:bold;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
  </form>

  <div id="message"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');
    const productInfo = document.getElementById('productInfo');
    const form = document.getElementById('orderForm');
    const message = document.getElementById('message');
    const totalPriceEl = document.getElementById('totalPrice');
    const quantityInput = document.getElementById('quantity');
    const pageTitle = document.getElementById('pageTitle');
    
    // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const productOptionsSet = document.getElementById('productOptionsSet');
    const colorsSection = document.getElementById('colorsSection');
    const colorsContainer = document.getElementById('colorsContainer');
    const selectedColorInput = document.getElementById('selectedColorInput');
    const sizesSection = document.getElementById('sizesSection');
    const sizesContainer = document.getElementById('sizesContainer');

    let currentProduct = null;

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
    async function loadProduct() {
      try {
        if (!productId) throw new Error("Ø±Ù‚Ù… Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
        const res = await fetch(`/products/${productId}`);
        if (!res.ok) throw new Error("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬");
        const product = await res.json();
        currentProduct = product;

         // 1. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØµÙÙˆÙØ©
        const imgUrl = (product.images && product.images.length) ? product.images[0] : (product.image || '');
        
        productInfo.innerHTML = `
 
            <div>
              <h2 style="margin:0 0 5px 0;">${product.name}</h2>
              <div style="color:#666; font-size:0.9em;">${product.description || ''}</div>
              <div style="font-weight:bold; color:#333; margin-top:5px;">${product.price}  DA</div>
            </div>
          </div>
        `;

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† (Colors)
        if (product.colors) {
          // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù† Ù…Ø®Ø²Ù†Ø§Ù‹ ÙƒÙ†Øµ Ù…ÙØµÙˆÙ„ Ø¨ÙØ§ØµÙ„Ø© Ø£Ùˆ Ù…ØµÙÙˆÙØ©)
          let colorsArr = Array.isArray(product.colors) ? product.colors : product.colors.split(',');
          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
          colorsArr = colorsArr.filter(c => c && c.trim() !== '');

          if (colorsArr.length > 0) {
            productOptionsSet.style.display = 'block';
            colorsSection.style.display = 'block';
            
            colorsArr.forEach(color => {
              const c = color.trim();
              const div = document.createElement('div');
              div.className = 'color-option';
              div.style.backgroundColor = c;
              div.title = c;
              div.onclick = () => selectColor(div, c);
              colorsContainer.appendChild(div);
            });
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù„ÙˆÙ† ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·ØŒ Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            if (colorsArr.length === 1) {
              selectColor(colorsContainer.children[0], colorsArr[0].trim());
            }
          }
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª (Sizes)
        if (product.sizes && product.sizes.trim() !== '') {
          productOptionsSet.style.display = 'block';
          sizesSection.style.display = 'block';

          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù‡Ù„ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ù‚Ø§Ø¦Ù…Ø©) Ø£Ù… Ù†Øµ Ø¹Ø§Ø¯ÙŠ
          if (product.sizes.includes(',')) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© (Select)
            let sizesArr = product.sizes.split(',');
            let selectHTML = `<select name="size" class="size-select" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù‚Ø§Ø³...</option>`;
            sizesArr.forEach(s => {
              const sizeVal = s.trim();
              if(sizeVal) selectHTML += `<option value="${sizeVal}">${sizeVal}</option>`;
            });
            selectHTML += `</select>`;
            sizesContainer.innerHTML = selectHTML;
          } else {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚Ù„ Ù†ØµÙŠ Ø¹Ø§Ø¯ÙŠ (Ù„Ø£Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ÙƒØªØ¨ Ù†ØµØ§Ù‹ Ø­Ø±Ø§Ù‹)
            sizesContainer.innerHTML = `
              <p style="font-size:12px; color:#666; margin-bottom:5px;">Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${product.sizes}</p>
              <input type="text" name="size" placeholder="Ø§ÙƒØªØ¨ Ù…Ù‚Ø§Ø³Ùƒ Ù‡Ù†Ø§..." required>
            `;
          }
        }

        updateTotal(); 
      } catch (err) {
        console.error(err);
        productInfo.innerHTML = "<p style='color:red; text-align:center;'>âŒ Ø®Ø·Ø£: Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø­Ø¯Ø«Øª Ù…Ø´ÙƒÙ„Ø©.</p>";
        form.style.display = 'none';
      }
    }

    function selectColor(element, colorValue) {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
      document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      element.classList.add('selected');
      selectedColorInput.value = colorValue;
      document.getElementById('colorError').style.display = 'none';
    }

    loadProduct();

    function updateTotal() {
      if (!currentProduct) return;
      const qty = parseInt(quantityInput.value) || 1;
      const total = qty * currentProduct.price;
      totalPriceEl.textContent = `Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()}  DA`;
    }
    quantityInput.addEventListener("input", updateTotal);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!currentProduct) {
        alert("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…Ø­Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
        return;
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ† (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù…Ø¹Ø±ÙˆØ¶Ø©)
      if (colorsSection.style.display !== 'none' && !selectedColorInput.value) {
        document.getElementById('colorError').style.display = 'block';
        // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø®Ø·Ø£
        colorsSection.scrollIntoView({ behavior: 'smooth' });
        return;
      }

      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ù†ØªØ¬
      data.product_id = productId;
      data.product_price = currentProduct.price;
      data.total_price = parseInt(quantityInput.value) * currentProduct.price;
      
      // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø­Ù‚ÙˆÙ„ color Ùˆ size ÙŠØªÙ… Ø¬Ù…Ø¹Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± FormData
      // color ÙŠØ£ØªÙŠ Ù…Ù† selectedColorInput (name="color")
      // size ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ù€ Select Ø£Ùˆ Input (name="size")

      try {
        const res = await fetch('/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const result = await res.json();
        
        if (res.ok) {
          // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
          form.style.display = 'none';
          productInfo.style.display = 'none';
          pageTitle.style.display = 'none';
          
          // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
          message.innerHTML = `
            <div class="success-wrapper">
              <div class="success-card">
                <svg class="checkmark-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                  <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
                  <path class="checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <h2 class="success-title">ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨Ùƒ!</h2>
                <p class="success-text">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§. Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>
                <a href="/" class="home-btn">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
              </div>
            </div>
          `;
        } else {
          message.innerHTML = `<p style="color:red; text-align:center; margin-top:20px;">âŒ ${result.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§'}</p>`;
        }
      } catch (err) {
        message.innerHTML = `<p style="color:red; text-align:center; margin-top:20px;">âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±</p>`;
      }
    });
  </script>
</body>
</html>